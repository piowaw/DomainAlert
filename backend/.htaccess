RewriteEngine On

# Pass Authorization header to PHP
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]

# Redirect to HTTPS (odkomentuj na produkcji)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# API routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ api/index.php [QSA,L]

# Frontend SPA routing (dla zbudowanego frontendu w tym samym katalogu)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.*)$ index.html [L]

# Zabezpieczenie plików konfiguracyjnych i bazy
<FilesMatch "\.(sqlite|db|log|env)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# Blokuj dostęp do config.php bezpośrednio
<Files "config.php">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</Files>

# Blokuj dostęp do services/
<IfModule mod_rewrite.c>
    RewriteRule ^services/ - [F,L]
    RewriteRule ^cron/ - [F,L]
</IfModule>

# Nagłówki bezpieczeństwa
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# PHP timeouts - AI endpoints need more time
<IfModule mod_php.c>
    php_value max_execution_time 600
    php_value max_input_time 600
</IfModule>

# For PHP-FPM (Plesk) — set timeout via PHP userini
<IfModule mod_fcgid.c>
    FcgidIOTimeout 600
    FcgidBusyTimeout 600
</IfModule>

# For mod_proxy_fcgi (used by Plesk with PHP-FPM)
<IfModule mod_proxy_fcgi.c>
    ProxyTimeout 600
</IfModule>
